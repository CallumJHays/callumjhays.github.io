<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" href="data:image/svg+xml,&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 100 100&quot;&gt;&lt;text y=&quot;.9em&quot; font-size=&quot;90&quot;&gt;👨‍💻&lt;/text&gt;&lt;/svg&gt;"/><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/6a6d65d10cc40f00b0b3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6a6d65d10cc40f00b0b3.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-4ed3b6591864f86e7beb.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.f783f7e0d786735fc5cd.js" as="script"/><link rel="preload" href="/_next/static/chunks/29107295.d0e2be3d2a1b6fbd4601.js" as="script"/><link rel="preload" href="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.c03b06ed0b290d3c7476.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-fc6e576d382907aecfe3.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/python_annotated_type_04012020-c895e5b6c5d5c9fb3cf9.js" as="script"/></head><body><div id="__next"><div id="particle-background"><canvas style="width:100%;height:100%"></canvas></div><p>Recently I came across Python&#x27;s <code>Annotated</code> type while <a href="https://github.com/micropython/micropython-lib/issues/190#issuecomment-751616492">migrating the <code>typing_extensions</code> library to micropython</a>. After some brief googling there didn&#x27;t appear to be much info in the community on how to use it, so I decided to write this post.</p><p>The <code>Annotated</code> type is the main focus of <a href="https://www.python.org/dev/peps/pep-0593/">PEP 539</a> released with the standard <code>typing</code> module in Python &gt;= 3.9 or with the <code>typing_extensions</code> library in previous versions.</p><p>In its basic form, <code>Annotated</code> lets you pack arbitrary python objects as a tuple in a <code>__metadata__</code> attribute of a type-hint:</p><pre><pre class="prism-code language-python" style="background-color:#2a2734;color:#9a86fd;padding:20px"><div class="token-line" style="color:#9a86fd"><span class="token keyword" style="color:#ffcc99">from</span><span class="token plain"> typing_extensions </span><span class="token keyword" style="color:#ffcc99">import</span><span class="token plain"> Annotated</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">SpecialInt </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> Annotated</span><span class="token punctuation" style="color:#6c6783">[</span><span class="token builtin">int</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;str Annotation&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token number" style="color:#e09142">42</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token string" style="color:#ffcc99">&#x27;hello&#x27;</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&#x27;world&#x27;</span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token keyword" style="color:#ffcc99">print</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">SpecialInt</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">__metadata__</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># (&#x27;str Annotation&#x27;, 42, {&#x27;hello&#x27;: &#x27;world&#x27;})</span><span class="token plain"></span></div></pre></pre><blockquote><p>PS: Usually &quot;<code>__attr__</code>&quot;s are better not accessed directly; there&#x27;s
generally a stdlib function that should be used instead (such as
<code>setattr()</code>). However I haven&#x27;t been able to find one for <code>__metadata__</code> (¯<!-- -->\<!-- -->_<!-- -->(ツ)<!-- -->_<!-- -->/¯)</p></blockquote><p>One of the best use-cases of <code>Annotated</code> I can think of is data validation for function inputs. Note there&#x27;s a bit of code required for the examples below to work. You can get the full working version <a href="https://gist.github.com/CallumJHays/e4ad98925894a8e1cd7ef57e90fe2807/">here</a>.</p><pre><pre class="prism-code language-python" style="background-color:#2a2734;color:#9a86fd;padding:20px"><div class="token-line" style="color:#9a86fd"><span class="token keyword" style="color:#ffcc99">from</span><span class="token plain"> typing_extensions </span><span class="token keyword" style="color:#ffcc99">import</span><span class="token plain"> Annotated </span><span class="token keyword" style="color:#ffcc99">as</span><span class="token plain"> An</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token keyword" style="color:#ffcc99">from</span><span class="token plain"> runtype_validation </span><span class="token keyword" style="color:#ffcc99">import</span><span class="token plain"> validate</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> InRange</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">@validate</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token keyword" style="color:#ffcc99">def</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">test_fn</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> An</span><span class="token punctuation" style="color:#6c6783">[</span><span class="token builtin">int</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> InRange</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token number" style="color:#e09142">0</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token number" style="color:#e09142">100</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">            b</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> An</span><span class="token punctuation" style="color:#6c6783">[</span><span class="token builtin">float</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> InRange</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token number" style="color:#e09142">0</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token keyword" style="color:#ffcc99">pass</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">test_fn</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token number" style="color:#e09142">50</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token number" style="color:#e09142">0.5</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token comment" style="color:#6c6783"># works</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">test_fn</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token number" style="color:#e09142">0.5</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token number" style="color:#e09142">0.5</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># TypeError: Expected a to have type &lt;class &#x27;int&#x27;&gt; but got &lt;class &#x27;float&#x27;&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">test_fn</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">b</span><span class="token operator" style="color:#e09142">=</span><span class="token number" style="color:#e09142">2</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> a</span><span class="token operator" style="color:#e09142">=</span><span class="token number" style="color:#e09142">50</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># AssertionError: Argument b=2 not in range [0, 1)</span><span class="token plain"></span></div></pre></pre><p>This works for class methods as well:</p><pre><pre class="prism-code language-python" style="background-color:#2a2734;color:#9a86fd;padding:20px"><div class="token-line" style="color:#9a86fd"><span class="token keyword" style="color:#ffcc99">class</span><span class="token plain"> </span><span class="token class-name">Test</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    @validate</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token keyword" style="color:#ffcc99">def</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">__init__</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">                 a</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> An</span><span class="token punctuation" style="color:#6c6783">[</span><span class="token builtin">int</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> InRange</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token number" style="color:#e09142">0</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token number" style="color:#e09142">100</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">                 b</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> An</span><span class="token punctuation" style="color:#6c6783">[</span><span class="token builtin">float</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> InRange</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token number" style="color:#e09142">0</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token keyword" style="color:#ffcc99">pass</span><span class="token plain"></span></div></pre></pre><p>Such a <code>@validate</code> decorator can decorate whole classes too, in which case it decorates each method of the class:</p><pre><pre class="prism-code language-python" style="background-color:#2a2734;color:#9a86fd;padding:20px"><div class="token-line" style="color:#9a86fd"><span class="token comment" style="color:#6c6783"># equivalent to previous example</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#6c6783">@validate</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token keyword" style="color:#ffcc99">class</span><span class="token plain"> </span><span class="token class-name">Test</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token keyword" style="color:#ffcc99">def</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">__init__</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">etc</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">.</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain"></span></div></pre></pre><p><code>typing.Annotated</code> is a very powerful and flexible tool when properly understood. If you have any other ideas for how to use <code>Annotated</code>, I&#x27;d love to hear about it in the comments below!</p><div shortname="callumjhays" config="[object Object]" id="disqus_thread"></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/blog/python_annotated_type_04012020","query":{},"buildId":"2xSs9rrhZoXiBg2fW6ozy","nextExport":true,"autoExport":true,"isFallback":false}</script><script nomodule="" src="/_next/static/chunks/polyfills-edc1e7c13d869669aedf.js"></script><script src="/_next/static/chunks/main-4ed3b6591864f86e7beb.js" async=""></script><script src="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" async=""></script><script src="/_next/static/chunks/framework.f783f7e0d786735fc5cd.js" async=""></script><script src="/_next/static/chunks/29107295.d0e2be3d2a1b6fbd4601.js" async=""></script><script src="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.c03b06ed0b290d3c7476.js" async=""></script><script src="/_next/static/chunks/pages/_app-fc6e576d382907aecfe3.js" async=""></script><script src="/_next/static/chunks/pages/blog/python_annotated_type_04012020-c895e5b6c5d5c9fb3cf9.js" async=""></script><script src="/_next/static/2xSs9rrhZoXiBg2fW6ozy/_buildManifest.js" async=""></script><script src="/_next/static/2xSs9rrhZoXiBg2fW6ozy/_ssgManifest.js" async=""></script></body></html>